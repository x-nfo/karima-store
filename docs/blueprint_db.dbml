// DATABASE SCHEMA: KARIMA FASHION ENTERPRISE (FINAL VERSION)
// Visualize this at https://dbdiagram.io/

// --- 1. PRODUCT & MEDIA SYSTEM ---
Table categories {
  id int [pk, increment]
  name varchar
  slug varchar [unique]
  parent_id int [null]
}

Table products {
  id uuid [pk]
  category_id int [ref: > categories.id]
  name varchar
  slug varchar [unique]
  description text
  material varchar
  is_busui_friendly boolean [default: false]
  is_wudhu_friendly boolean [default: false]
  status enum('draft', 'active', 'archived')
  created_at timestamp
}

Table product_media {
  id uuid [pk]
  product_id uuid [ref: > products.id]
  url text
  media_type enum('image', 'video')
  sort_order int // Untuk foto utama
}

Table product_skus {
  id uuid [pk]
  product_id uuid [ref: > products.id]
  sku_code varchar [unique]
  color varchar
  size varchar
  stock int
  hpp_price decimal(12,2)
  base_price decimal(12,2)
  weight_grams int
}

// --- 2. BUNDLING SYSTEM (SET PRODUK) ---
Table product_bundles {
  id uuid [pk]
  name varchar
  bundle_price decimal(12,2)
  is_active boolean [default: true]
}

Table bundle_items {
  id int [pk, increment]
  bundle_id uuid [ref: > product_bundles.id]
  product_sku_id uuid [ref: > product_skus.id]
  quantity int
}

// --- 3. CUSTOMER & PRICE TIERING ---
Table customer_groups {
  id int [pk, increment]
  group_name varchar // Retail, Reseller, Agen
  min_order_qty int
}

Table users {
  id uuid [pk] // Linked to Ory Kratos ID
  group_id int [ref: > customer_groups.id]
  email varchar [unique]
  full_name varchar
  phone varchar
}

Table product_tier_prices {
  id int [pk, increment]
  product_sku_id uuid [ref: > product_skus.id]
  group_id int [ref: > customer_groups.id]
  discount_type enum('percentage', 'fixed_price')
  discount_value decimal(12,2)
}

// --- 4. SHIPPING (RAJAONGKIR / KOMERCE READY) ---
Table shipping_addresses {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  label varchar
  receiver_name varchar
  receiver_phone varchar
  province_id int
  city_id int
  subdistrict_id int
  postal_code varchar
  address_detail text
  is_default boolean [default: false]
}

// --- 5. ORDERS & FINANCIALS (MIDTRANS READY) ---
Table orders {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  order_number varchar [unique]

  total_items_price decimal(12,2)
  total_shipping_cost decimal(12,2)
  total_discount decimal(12,2)
  grand_total decimal(12,2)

  payment_status enum('unpaid', 'paid', 'expired', 'failed')
  midtrans_snap_token varchar
  midtrans_transaction_id varchar

  shipping_courier varchar
  shipping_service varchar
  shipping_receipt_number varchar
  order_status enum('pending', 'processing', 'shipped', 'delivered', 'cancelled')

  created_at timestamp
}

Table order_items {
  id uuid [pk]
  order_id uuid [ref: > orders.id]
  product_sku_id uuid [ref: > product_skus.id, null]
  bundle_id uuid [ref: > product_bundles.id, null]
  quantity int
  price_at_purchase decimal(12,2)
  hpp_at_purchase decimal(12,2)
}

// --- 6. AUDIT LOGS ---
Table activity_logs {
  id bigint [pk, increment]
  admin_id uuid
  action varchar
  description text
  ip_address varchar
  created_at timestamp
}

// --- 7. FLASH SALES ---
Table flash_sales {
  id uuid [pk]
  title varchar
  start_time timestamp
  end_time timestamp
  is_active boolean
}

Table flash_sale_items {
  id int [pk, increment]
  flash_sale_id uuid [ref: > flash_sales.id]
  product_sku_id uuid [ref: > product_skus.id]
  flash_price decimal(12,2)
  flash_stock int
  sold_count int [default: 0]
}